---
title: "An analysis of average weekly attendance per month for Kettering SDA Church"
author: "James R. Milks"
date: "Last compiled on `r format(Sys.Date(), '%d %B %Y')`"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.keep = "all")
options(scipen = 1, digits = 2)
```

## Background

Seventh-day Adventist churches in Ohio have been required to count weekly attendance during church services since the mid-1980's. I examined average weekly attendance per month for the Kettering Seventh-day Adventist Church to detect patterns and changes between January 2002 and March 2020. The church closed due to the COVID19 pandemic in mid-March 2020 and reopened in April 2021. I use three time series models to forecast three years of attendance to assess the impact of COVID19 on church attendance after the church reopened.

```{r packages, include = FALSE}
library(modeltime)
library(tidyverse)
library(timetk)
library(lubridate)
library(tidymodels)
library(forecast)
library(patchwork)
```

## Methods

I pulled weekly attendance records from January 2010 - March 2020. I then used auto.arima to calculate the best-fit seasonal ARIMA (SARIMA) model and Ljung-Box test to check for autoregression in the residuals of the model as a check on the quality of the model. Unfortunately, the Ljung-Box test indicated that the SARIMA model did not fully model the degree of autoregression in the weekly attendance data.

I then calculated the average weekly attendance per month and combined those results with an older data set containing average weekly attendance from January 2002 to December 2009. I repeated my analysis and found that this time, the Ljung-Box test indicated that the SARIMA model was adequate. Building off that success, I used six different models to forecast the average weekly attendance per month for three years and compared the forecasts to actual in-person attendance since the church reopened in April 2021.

After that, Pastor Tim gathered viewership data for the online broadcast for the church service starting in April 2020 and continuing to this day. We used the first 24-hour unique views as an estimate of the virtual attendance at our online service, both to capture those viewers who watch during and after the premiere but limit the possibilities of repeated views. This likely underestimates true attendance, as multiple people could watch the service during each unique view but will only count as one unique view. I modeled the weekly and monthly average data as well to see if there were any notable patterns.

Finally, I combined the online viewership and in-person attendance records to gain insights into changes in total attendance since the start of the COVID19 pandemic.

## In-person attendance

```{r import data}
Weekly_total <- read.csv("Weekly total-Table 1.csv", header = T)
Weekly_total$Date <- as.Date(Weekly_total$Date)
Average_by_month <- Weekly_total %>% 
        group_by(month = floor_date(Date, "month")) %>% 
        summarize(attendance = mean(attendance, na.rm = TRUE))
names(Average_by_month) <- c("Date", "attendance")

Monthly_average <- read.csv("Monthly average-KetSDA.csv", header = T)
Monthly_average$Date <- sprintf("%d-%02d", Monthly_average$Year, Monthly_average$Month)
Monthly_average_sub <- subset(Monthly_average, Year < 2010)
Monthly_average_sub <- Monthly_average_sub[,-c(1,2,4)]
names(Monthly_average_sub) <- c("attendance", "Date")
Monthly_average_sub$Date <- as.Date(paste(Monthly_average_sub$Date, "-01", sep = ""))
attendance_full <- rbind(Monthly_average_sub, Average_by_month)

g <- ggplot(attendance_full, aes(x = Date, y = attendance)) +
        theme_bw() +
        geom_line() +
        geom_point() +
        geom_smooth(method = "loess", formula = "y~x", col = "red") +
        labs(title = "Weekly mean in-person attendance by month 2002-2021",
             subtitle = "Kettering SDA Church, Kettering, Ohio",
             x = "Date",
             y = "Average weekly attendance")
g
```

Plotting a loess regression line on in-person attendance since 2002 reveals that attendance has fallen from just over 700 people per week in 2002 to 500 currently. That is not the full picture, however. Before the COVID19-induced shutdown, the church was averaging about 590 people per week. In-person attendance since the church reopened has been closer to 400 per week, a loss of roughly 190 people, reversing the upward trend in the data before the shutdown.

## Preliminary work

To demonstrate just how much COVID19 affected in-person attendance, I checked for seasonal patterns  using decomposition along with autocorrelation function and partial autocorrelation function tests.

```{r decomposition}
monthly <- subset(attendance_full, Date <= as.Date("2020-03-01"))
monthly$attendance <- na.interp(monthly$attendance) %>%
        as.numeric()
monthly_ts <- ts(monthly$attendance, start = c(2002, 1), frequency = 12)

plot(decompose(monthly_ts))
```

Decomposition revealed the existence of seasonal cycles within the time series, which must be accounted for in the model.

```{r ACF and PACF}
par(mfrow = c(1,2))
acf(diff(monthly_ts), main = "")
pacf(diff(monthly_ts), main = "")
```

Autocorrelation function (ACF) and partial autocorrelation function (PACF) revealed autocorrelations within both the trend (autoregression) and the statistical noise (moving average) of the data after all trends were removed with a differencing operation. They also revealed seasonal autoregression, wherein each data point is autocorrelated with the data point twelve months prior, confirming the existence of seasonal cycles within the data.

## Models

I split the existing data into training and testing data sets to assess model accuracy and select the best model. I used 2002-2019 as the training data and 2019-2020 as the testing data set as shown below.

```{r Models}
splits <- monthly %>%
        time_series_split(assess = "1 years", cumulative = TRUE)

splits %>%
        tk_time_series_cv_plan() %>%
        plot_time_series_cv_plan(Date, attendance, .interactive = FALSE)
```
The six models I tested were SARIMA, Prophet, GLMNet, Random Forest, Prophet with XGBoost errors and ARIMA with XGBoost. The last four are all machine learning algorithms. All six were fitted using the training time period and then attempted to predict the testing time period.

```{r, models, include = FALSE, echo=FALSE}
# Auto SARIMA model
model_fit_sarima <- arima_reg() %>%
        set_engine("auto_arima") %>%
        fit(attendance~Date, training(splits))

# Prophet model
model_fit_prophet <- prophet_reg(seasonality_yearly = TRUE) %>%
        set_engine("prophet") %>%
        fit(attendance~Date, training(splits))

# Machine learning
recipe_spec <- recipe(attendance~Date, training(splits)) %>%
        step_timeseries_signature(Date) %>%
        step_fourier(Date, period = 12, K = 5) %>%
        step_dummy(all_nominal())

recipe_spec %>%
        prep() %>%
        juice()

## Elastic Net
model_spec_glmnet <- linear_reg(penalty = 0.01, mixture = 0.5) %>%
        set_engine("glmnet")

workflow_fit_glmnet <- workflow() %>%
        add_model(model_spec_glmnet) %>%
        add_recipe(recipe_spec %>%
                           step_rm(Date)) %>%
        fit(training(splits))

## Random Forest
model_spec_rf <- rand_forest(trees = 500, min_n = 50) %>%
        set_engine("randomForest")

workflow_fit_rf <- workflow() %>%
        add_model(model_spec_rf) %>%
        add_recipe(recipe_spec %>%
                           step_rm(Date)) %>%
        fit(training(splits))

##Prophet Boost
model_spec_prophet_boost <- prophet_boost(seasonality_yearly = TRUE) %>%
        set_engine("prophet_xgboost")

workflow_fit_prophet_boost <- workflow() %>%
        add_model(model_spec_prophet_boost) %>%
        add_recipe(recipe_spec) %>%
        fit(training(splits))

##ARIMA Boost
model_spec_arima_boost <- arima_boost() %>%
        set_engine("auto_arima_xgboost")

workflow_fit_arima_boost <- workflow() %>%
        add_model(model_spec_arima_boost) %>%
        add_recipe(recipe_spec) %>%
        fit(training(splits))
```
```{r tables, warning=FALSE, echo=FALSE}
## Organize models
model_table <- modeltime_table(
        model_fit_sarima,
        model_fit_prophet,
        workflow_fit_glmnet,
        workflow_fit_rf,
        workflow_fit_prophet_boost,
        workflow_fit_arima_boost
)

# Calibration
calibration_table <- model_table %>%
        modeltime_calibrate(testing(splits))

# Forecast (Testing Set)
calibration_table %>%
        modeltime_forecast(actual_data = monthly) %>%
        plot_modeltime_forecast(.interactive = FALSE)
```

Accuracy testing revealed that the Prophet with XGBoost Errors was the most accurate, with an R^2^ value of 0.51. That corresponds to correlation coefficient r = `r sqrt(0.51)`, a decent fit between predicted and actual values.

```{r accuracy testing, include = TRUE}
# Accuracy testing
calibration_table %>%
        modeltime_accuracy() %>%
        table_modeltime_accuracy(.interactive = FALSE)

```

### Predictions vs Actual

Once the best model was found, I re-fitted it to the full data set, then predicted the next three years of attendance assuming that COVID19 had not happened.

```{r refit}
calibration_table %>%
        filter(.model_id == c(5)) %>%
        modeltime_refit(monthly) %>%
        modeltime_forecast(h = "36 months", actual_data = monthly) %>%
        plot_modeltime_forecast(.interactive = FALSE)
```

In-person attendance has been lagging the predicted attendance since Kettering Adventist Church reopened in April 2021.

```{r, Actual vs predicted, echo = FALSE, message = FALSE, warning=FALSE}
compare <- calibration_table %>%
        filter(.model_id == c(5)) %>%
        modeltime_refit(monthly) %>%
        modeltime_forecast(h = "36 months", actual_data = monthly) %>%
        filter(.index >= "2021-04-01" & .index <= "2021-11-01") %>%
        select(.index, .value) %>%
        rename(Month = .index) %>%
        rename(Predicted = .value)

future <- subset(attendance_full, Date >= as.Date("2021-04-01"))

combo_predicted_vs_actual <- cbind(compare, future)
pred_vs_actual <- combo_predicted_vs_actual %>%
        rename(Actual = attendance) %>%
        select(Month, Predicted, Actual) %>%
        pivot_longer(cols = c(Predicted, Actual)) %>%
        rename(Category = name)

ggplot(pred_vs_actual, aes(x = Month, y = value, color = Category)) +
        geom_line() +
        theme(legend.position = "bottom") +
        labs(title = "Predicted vs actual in-person attendance",
             subtitle = "April 2021 - November 2021",
             x = "Month",
             y = "Attendance")
```
```{r percent difference, echo = FALSE, message = FALSE, warning=FALSE}
percent_diff <- ((future$attendance - compare$Predicted) / compare$Predicted) * 100
month <- c("2021-04-01", "2021-05-01", "2021-06-01", "2021-07-01", "2021-08-01", "2021-09-01", "2021-10-01", "2021-11-01")
month <- as.Date(month)
percent_diff_df <- data.frame(month = month, percent_diff = percent_diff)
ggplot(percent_diff_df, aes(x = month, y = percent_diff)) +
        geom_bar(stat = "identity") +
        labs(title = "Predicted vs actual in-person attendance",
             subtitle = "April 2021 - November 2021",
             x = "Month",
             y = "Percent difference")
```

In-person attendance has ranged from `r max(percent_diff)`% lower than predicted in May 2021 down to `r min(percent_diff)`% lower than predicted in August 2021. It has mostly ranged between 20 and 30% lower than predicted.

## Online Attendance

We have estimates of the unique viewers from YouTube on the livestream ministry from December 2017. I chose the unique viewers for the first 24 hours each livestream video was up as a measure of our online audience. This captures our viewers who may not tune in during the live broadcast while minimizing repeat views. Additionally, I excluded broadcasts done while the church was on hiatus from the middle of March 2020 until April 2021 to ensure apples-to-apples comparisons between online and in-person viewership over time.

```{r, online, warning = FALSE}
Weekly_total$Online <- with(Weekly_total,
                            ifelse(is.na(FirstServe24) & is.na(SecondServe24), NA,
                                   ifelse(is.na(FirstServe24), 0 + SecondServe24,
                                          ifelse(is.na(SecondServe24), FirstServe24 + 0,
                                                 FirstServe24 + SecondServe24
                                          )
                                   )
                            )
)

Online_Average_by_month <- Weekly_total %>% 
        group_by(month = floor_date(Date, "month")) %>% 
        summarize(Online = mean(Online, na.rm = TRUE)) %>%
        filter(month >= as.Date("2017-12-01"))

o <- ggplot(Online_Average_by_month, aes(x = month, y = Online)) +
        theme_bw() +
        geom_line() +
        geom_point() +
        geom_smooth(method = "loess", formula = "y~x", col = "red") +
        labs(title = "Weekly mean online attendance by month 2017-2021",
             subtitle = "Kettering SDA Church, Kettering, Ohio",
             x = "Date",
             y = "Average weekly online attendance")
o
```

As you can see, our online ministry grew tremendously from about 100 unique viewers per week in December 2017 to just under 250 unique viewers per week before we shut down in March 2020. Since reopening, our viewership started at around 440 unique viewers per week but has declined to just over 310 unique viewers per week. Unfortunately, there is not enough data yet to explore seasonal patterns or forecast predictions for online attendance alone.

## In-person plus Online attendance

Adding the online attendance to the in-person attendance shows that online attendance now makes up a significant proportion of the total attendance, pushing total attendance to its highest levels in 20 years. However, this comes with one major caveat: We only have unique viewer data from December 2017. The live streaming ministry started around 2012 but earlier versions were archived on Vimeo, not YouTube. Estimates of the size of the online audience on Vimeo do not, to my knowledge, exist. However, given that many of the church service videos we have on Vimeo have yet to gather 100 views total since they were posted between 2012 and 2017, the online audience before we switched to YouTube in December 2017 is likely to be minimal.

```{r, combined}
Weekly_total$Combined <- with(Weekly_total,
                              ifelse(is.na(attendance) & is.na(Online), NA,
                                     ifelse(is.na(attendance), 0 + Online,
                                            ifelse(is.na(Online), attendance + 0,
                                                   attendance + Online
                                                   )
                                            )
                                     )
                              )

Combined_Average_by_month <- Weekly_total %>% 
        group_by(Date = floor_date(Date, "month")) %>% 
        summarize(attendance = mean(Combined, na.rm = TRUE))

Full_Average_by_month <- rbind(Monthly_average_sub, Combined_Average_by_month) %>%
        mutate(color = ifelse(Date < as.Date("2017-12-01"), "In-person", "In-person + Online"))

monthly_combo <- attendance_full %>% 
        left_join(Full_Average_by_month, by = "Date") %>% 
        rename("In-person" = attendance.x, "In-person + Online" = attendance.y) %>%
        pivot_longer(-c(Date, color)) %>%
        rename("Category" =  name, "Weekly Attendance" = value)

ggplot(monthly_combo, aes(x = Date, y = `Weekly Attendance`, colour = Category, group = Category)) +
        geom_point() +
        geom_line(size = 1) +
        geom_smooth(method = "loess", formula = "y~x") +
        scale_color_hue(direction = 1) +
        labs(x = "Date",
             y = "Average weekly attendance",
             title = "Average weekly attendance by month",
             subtitle = "Kettering SDA Church") +
        theme_minimal() +
        theme(legend.position = "bottom")
```

As we can see, adding in the online viewership increases our weekly average audience to levels last seen in 2002, in sharp contrast to the trend in in-person attendance alone. It appears an increasing percentage of our weekly church audience is meeting with us online.

```{r, barplot attendance, warning = FALSE}
bar <- Weekly_total %>%
        filter(Date >= as.Date("2017-12-23")) %>%
        group_by(Date = floor_date(Date, "month")) %>% 
        summarize(in.person = mean(attendance, na.rm = TRUE), online = mean(Online, na.rm = TRUE))

bar_pre <- bar %>%
        filter(Date <= as.Date("2020-03-01")) %>%
        gather(method, attendees, online:in.person)

bar_post <- bar %>%
        filter(Date >= as.Date("2021-04-01")) %>%
        gather(method, attendees, online:in.person)

b_pre <- ggplot(bar_pre, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "stack", stat = "identity") +
        labs(title = "Combined weekly attendance pre-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Number of attendees")

per_pre <- ggplot(bar_pre, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "fill", stat = "identity") +
        labs(title = "Combined weekly attendance pre-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Percentage")

b_post <- ggplot(bar_post, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "stack", stat = "identity") +
        labs(title = "Combined weekly attendance post-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Number of attendees")

per_post <- ggplot(bar_post, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "fill", stat = "identity") +
        labs(title = "Combined weekly attendance post-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Percentage")
b_pre / b_post

lfy <- Weekly_total %>%
        filter(Date >= as.Date("2019-02-01") & Date < as.Date("2020-03-01")) %>%
        summarize(in.person = mean(attendance, na.rm = TRUE), online = mean(Online, na.rm = TRUE))
reopening <- Weekly_total %>%
        filter(Date >= as.Date("2021-04-01")) %>%
        summarize(in.person = mean(attendance, na.rm = TRUE), online = mean(Online, na.rm = TRUE))
```

From February 2019 to February 2020 (the last full year before the church shut down for the pandemic), in-person attendance averaged `r lfy$in.person` per week with an average online attendance of `r lfy$online` per week for a total weekly attendance of `r lfy$in.person + lfy$online`. Since reopening, church attendance has averaged `r reopening$in.person + reopening$online` per week, with `r reopening$in.person` meeting in person and `r reopening$online` joining online. In-person attendance is down `r lfy$in.person - reopening$in.person` but an increase of `r reopening$online - lfy$online` in online attendance has made up for the loss of in-person attendance.

```{r, percentage in-person vs online}
per_pre / per_post

percentages_lfy <- Weekly_total %>%
        filter(Date >= as.Date("2019-02-01") & Date < as.Date("2020-03-01")) %>%
        mutate(percent_in.person = (attendance / (attendance + Online)) * 100) %>%
        mutate(percent_online = (Online / (attendance + Online)) * 100) %>%
        summarize(in.person = mean(percent_in.person, na.rm = TRUE), online = mean(percent_online, na.rm = TRUE))

percentages_reopening <- Weekly_total %>%
        filter(Date >= as.Date("2021-04-01")) %>%
        mutate(percent_in.person = (attendance / (attendance + Online)) * 100) %>%
        mutate(percent_online = (Online / (attendance + Online)) * 100) %>%
        summarize(in.person = mean(percent_in.person, na.rm = TRUE), online = mean(percent_online, na.rm = TRUE))
```

Before the pandemic, an average of `r percentages_lfy$online`% of our weekly audience came from our online ministry. Since reopening, however, `r percentages_reopening$online`% of our weekly audience has been online.

# Conclusions

Engaging with our expanded online audience is imperative for continued church growth. Here are a few of my own suggestions to consider for starters:

        * Increase Zoom access in Sabbath Schools 
                + N3, N4, and Upper Room Sabbath Schools for adults 
                + Perichoresis and 4:13 for teens
        * Zoom access to the children's division Sabbath Schools
                + Create an online Sabbath School program instead?
        * Mid-week Bible Studies online?

However we respond, the numbers are clear: People are now doing church differently thanks to COVID-19 so we as the church must adapt. History suggests that we will eventually settle on a new normal but given the online revolution it is unclear as yet just what that new normal will be.

# Future Directions

One question I would dearly love to answer is "What is the age distribution of our congregation?" Knowing the answer would allow us to not only more accurately meet the current needs of our congregation but also to plan for future needs. For example, if we see that we're bottom heavy, with a lot of small children, we know that we need to beef up the children's programs now and that in ten years we will have plenty of teenagers and plan to beef up 4:13 and Perichoresis accordingly. Conversely, if we're top heavy with a lot of senior citizens, we can create additional supports for an aging congregation now and also plan for a demographic shift in the future.

I created a sample of the type of survey I would like to use to gather this information. You can find it on my Shiny Apps page at [https://jrmilks.shinyapps.io/KetSDA_demographics/](https://jrmilks.shinyapps.io/KetSDA_demographics/) Note that this is just an example. I'm sure there are more sophisticated ways to gather this information.

# Additional Information

I created an interactive dashboard of both in-person and online attendance at Kettering SDA Church. You can find it online at [https://jrmilks.shinyapps.io/KetSDAweeklyattendance/](https://jrmilks.shinyapps.io/KetSDAweeklyattendance/). In it, you'll find both the previous week's total, in-person, and online attendance, the current monthly average of those three categories, and the year-to-date averages. Additionally, I created an interactive time series graph. You can select between three different data sets to view, then zoom in and out, select specific time periods, and view the coordinates of data points with your mouse.

# Software used to create this report:

* R version 4.1.1
* RStudio 2021.09.0 Build 351

## Packages
```{r, packages_names}
subset(data.frame(sessioninfo::package_info()), attached == TRUE, c(package, loadedversion))
```