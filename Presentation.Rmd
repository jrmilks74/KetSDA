---
title: "KetSDA weekly attendance over time"
author: "James R. Milks"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.keep = "all")
options(scipen = 1, digits = 2)
library(modeltime)
library(tidyverse)
library(timetk)
library(lubridate)
library(tidymodels)
library(forecast)
library(patchwork)

Weekly_total <- read.csv("Weekly total-Table 1.csv", header = T)
Weekly_total$Date <- as.Date(Weekly_total$Date)
Average_by_month <- Weekly_total %>% 
        group_by(month = floor_date(Date, "month")) %>% 
        summarize(attendance = mean(attendance, na.rm = TRUE))
names(Average_by_month) <- c("Date", "attendance")

Monthly_average <- read.csv("Monthly average-KetSDA.csv", header = T)
Monthly_average$Date <- sprintf("%d-%02d", Monthly_average$Year, Monthly_average$Month)
Monthly_average_sub <- subset(Monthly_average, Year < 2010)
Monthly_average_sub <- Monthly_average_sub[,-c(1,2,4)]
names(Monthly_average_sub) <- c("attendance", "Date")
Monthly_average_sub$Date <- as.Date(paste(Monthly_average_sub$Date, "-01", sep = ""))
attendance_full <- rbind(Monthly_average_sub, Average_by_month)

Weekly_total$Online <- with(Weekly_total,
                            ifelse(is.na(FirstServe24) & is.na(SecondServe24), NA,
                                   ifelse(is.na(FirstServe24), 0 + SecondServe24,
                                          ifelse(is.na(SecondServe24), FirstServe24 + 0,
                                                 FirstServe24 + SecondServe24
                                          )
                                   )
                            )
)

Online_Average_by_month <- Weekly_total %>% 
        group_by(month = floor_date(Date, "month")) %>% 
        summarize(Online = mean(Online, na.rm = TRUE)) %>%
        filter(month >= as.Date("2017-12-01"))

Weekly_total$Combined <- with(Weekly_total,
                              ifelse(is.na(attendance) & is.na(Online), NA,
                                     ifelse(is.na(attendance), 0 + Online,
                                            ifelse(is.na(Online), attendance + 0,
                                                   attendance + Online
                                                   )
                                            )
                                     )
                              )

Combined_Average_by_month <- Weekly_total %>% 
        group_by(Date = floor_date(Date, "month")) %>% 
        summarize(attendance = mean(Combined, na.rm = TRUE))

Full_Average_by_month <- rbind(Monthly_average_sub, Combined_Average_by_month) %>%
        mutate(color = ifelse(Date < as.Date("2017-12-01"), "In-person", "In-person + Online"))

monthly_combo <- attendance_full %>% 
        left_join(Full_Average_by_month, by = "Date") %>% 
        rename("In-person" = attendance.x, "In-person + Online" = attendance.y) %>%
        pivot_longer(-c(Date, color)) %>%
        rename("Category" =  name, "Weekly Attendance" = value)
```

## Introduction

Weekly attendance at Kettering SDA Church has fluctuated with time. Here I present the results of an analysis of attendance patterns since 2002.

- In-person vs Online

- Interactive Dashboard

- Time Series analysis

## In-person vs Online

```{r combined vs in-person}
ggplot(monthly_combo, aes(x = Date, y = `Weekly Attendance`, colour = Category, group = Category)) +
        geom_point() +
        geom_line(size = 1.2) +
        geom_smooth(method = "loess", formula = "y~x") +
        scale_color_hue(direction = 1) +
        labs(x = "Date",
             y = "Average weekly attendance",
             title = "Average weekly attendance by month for Kettering SDA Church") +
        theme_minimal() +
        theme(legend.position = "bottom")
```
Since 2017, the online audience has increased in size and percentage of the total whereas in-person attendance has declined (mostly due to COVID).

## In-person vs Online

```{r online}
o <- ggplot(Online_Average_by_month, aes(x = month, y = Online)) +
        theme_bw() +
        geom_line() +
        geom_point() +
        geom_smooth(method = "loess", formula = "y~x", col = "red") +
        labs(title = "Weekly mean online attendance by month 2017-2021",
             subtitle = "Kettering SDA Church, Kettering, Ohio",
             x = "Date",
             y = "Average weekly online attendance")
o
```

## In-person vs Online

```{r pressure}
bar <- Weekly_total %>%
        filter(Date >= as.Date("2017-12-23")) %>%
        group_by(Date = floor_date(Date, "month")) %>% 
        summarize(in.person = mean(attendance, na.rm = TRUE), online = mean(Online, na.rm = TRUE))

bar_pre <- bar %>%
        filter(Date <= as.Date("2020-03-01")) %>%
        gather(method, attendees, online:in.person)

bar_post <- bar %>%
        filter(Date >= as.Date("2021-04-01")) %>%
        gather(method, attendees, online:in.person)

b_pre <- ggplot(bar_pre, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "stack", stat = "identity") +
        labs(title = "Combined weekly attendance pre-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Number of attendees")

per_pre <- ggplot(bar_pre, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "fill", stat = "identity") +
        labs(title = "Combined weekly attendance pre-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Percentage")

b_post <- ggplot(bar_post, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "stack", stat = "identity") +
        labs(title = "Combined weekly attendance post-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Number of attendees")

per_post <- ggplot(bar_post, aes(x = Date, y = attendees, fill = method)) +
        geom_bar(position = "fill", stat = "identity") +
        labs(title = "Combined weekly attendance post-pandemic",
             subtitle = "Kettering SDA Church",
             x = "Date",
             y = "Percentage")
b_pre / b_post
```

## In-person vs Online

```{r numbers}
lfy <- Weekly_total %>%
        filter(Date >= as.Date("2019-02-01") & Date < as.Date("2020-03-01")) %>%
        summarize(in.person = mean(attendance, na.rm = TRUE), online = mean(Online, na.rm = TRUE))
reopening <- Weekly_total %>%
        filter(Date >= as.Date("2021-04-01")) %>%
        summarize(in.person = mean(attendance, na.rm = TRUE), online = mean(Online, na.rm = TRUE))
```

- February 2019 - February 2020

        + In-person attendance averaged `r lfy$in.person` per week
        
        + Online attendance averaged `r lfy$online` per week 
        
        + Average total weekly attendance was `r lfy$in.person + lfy$online`. 
        
- Since April 2021

        + Total church attendance has averaged `r reopening$in.person + reopening$online` per week
        
        + In-person attendance averaged `r reopening$in.person` 
        
        + Online attendance averaged `r reopening$online` 

In-person attendance is down `r lfy$in.person - reopening$in.person` but an increase of `r reopening$online - lfy$online` in online attendance has made up for the loss of in-person attendance.

## In-person vs Online

```{r percentages}
percentages_lfy <- Weekly_total %>%
        filter(Date >= as.Date("2019-02-01") & Date < as.Date("2020-03-01")) %>%
        mutate(percent_in.person = (attendance / (attendance + Online)) * 100) %>%
        mutate(percent_online = (Online / (attendance + Online)) * 100) %>%
        summarize(in.person = mean(percent_in.person, na.rm = TRUE), online = mean(percent_online, na.rm = TRUE))

percentages_reopening <- Weekly_total %>%
        filter(Date >= as.Date("2021-04-01")) %>%
        mutate(percent_in.person = (attendance / (attendance + Online)) * 100) %>%
        mutate(percent_online = (Online / (attendance + Online)) * 100) %>%
        summarize(in.person = mean(percent_in.person, na.rm = TRUE), online = mean(percent_online, na.rm = TRUE))

per_pre / per_post
```

Before the pandemic, an average of `r percentages_lfy$online`% of our weekly audience came from our online ministry. Since reopening, however, `r percentages_reopening$online`% of our weekly audience has been online.

## In-person vs Online

- I created an interactive dashbaord to track in-person and online attendance.
- Find it at [https://jrmilks.shinyapps.io/KetSDAweeklyattendance/][https://jrmilks.shinyapps.io/KetSDAweeklyattendance/]
![dashboard](dashboard.png)

## Additional analysis

- I did a time series analysis of in-person attendance 2002-2020 up to March 202, then used the best fit model to predict future attendance.
- Used the last 12 months  as a test set, the rest as the training

```{r time series training vs testing}
splits <- monthly %>%
        time_series_split(assess = "1 years", cumulative = TRUE)
splits %>%
        tk_time_series_cv_plan() %>%
        plot_time_series_cv_plan(Date, attendance, .interactive = FALSE)
```

## Time Series Models

```{r Time series models, warning = FALSE}
# Auto SARIMA model
model_fit_sarima <- arima_reg() %>%
        set_engine("auto_arima") %>%
        fit(attendance~Date, training(splits))

# Prophet model
model_fit_prophet <- prophet_reg(seasonality_yearly = TRUE) %>%
        set_engine("prophet") %>%
        fit(attendance~Date, training(splits))

# Machine learning
recipe_spec <- recipe(attendance~Date, training(splits)) %>%
        step_timeseries_signature(Date) %>%
        step_fourier(Date, period = 12, K = 5) %>%
        step_dummy(all_nominal())

recipe_spec %>%
        prep() %>%
        juice()

## Elastic Net
model_spec_glmnet <- linear_reg(penalty = 0.01, mixture = 0.5) %>%
        set_engine("glmnet")

workflow_fit_glmnet <- workflow() %>%
        add_model(model_spec_glmnet) %>%
        add_recipe(recipe_spec %>%
                           step_rm(Date)) %>%
        fit(training(splits))

## Random Forest
model_spec_rf <- rand_forest(trees = 500, min_n = 50) %>%
        set_engine("randomForest")

workflow_fit_rf <- workflow() %>%
        add_model(model_spec_rf) %>%
        add_recipe(recipe_spec %>%
                           step_rm(Date)) %>%
        fit(training(splits))

##Prophet Boost
model_spec_prophet_boost <- prophet_boost(seasonality_yearly = TRUE) %>%
        set_engine("prophet_xgboost")

workflow_fit_prophet_boost <- workflow() %>%
        add_model(model_spec_prophet_boost) %>%
        add_recipe(recipe_spec) %>%
        fit(training(splits))

##ARIMA Boost
model_spec_arima_boost <- arima_boost() %>%
        set_engine("auto_arima_xgboost")

workflow_fit_arima_boost <- workflow() %>%
        add_model(model_spec_arima_boost) %>%
        add_recipe(recipe_spec) %>%
        fit(training(splits))

## Organize models
model_table <- modeltime_table(
        model_fit_sarima,
        model_fit_prophet,
        workflow_fit_glmnet,
        workflow_fit_rf,
        workflow_fit_prophet_boost,
        workflow_fit_arima_boost
)

# Calibration
calibration_table <- model_table %>%
        modeltime_calibrate(testing(splits))

# Forecast (Testing Set)
calibration_table %>%
        modeltime_forecast(actual_data = monthly) %>%
        plot_modeltime_forecast(.interactive = FALSE)
```